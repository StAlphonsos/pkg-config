From 92dbc3ab73f177e0326f3cc3097b6708e495ac07 Mon Sep 17 00:00:00 2001
From: Jasper Lievisse Adriaanse <jasper@humppa.nl>
Date: Mon, 7 Mar 2011 11:11:25 +0100
Subject: [PATCH 08/14] - implement PKG_CONFIG_SYSROOT_DIR
 - bump version to 0.23

---
 pkg-config   |   23 ++++++++++++++++++++---
 pkg-config.1 |    6 ++++++
 2 files changed, 26 insertions(+), 3 deletions(-)

diff --git a/pkg-config b/pkg-config
index 26d63f8..a12464d 100644
--- a/pkg-config
+++ b/pkg-config
@@ -39,7 +39,7 @@ my $allow_uninstalled =
 	defined $ENV{PKG_CONFIG_DISABLE_UNINSTALLED} ? 0 : 1;
 my $found_uninstalled = 0;
 
-my $version = 0.22; # pretend to be this version of pkgconfig
+my $version = 0.23; # pretend to be this version of pkgconfig
 
 my %configs = ();
 my %mode = ();
@@ -53,6 +53,12 @@ my $D = 0; # debug flag
     } else {
 	    $variables->{pc_top_builddir} = '$(top_builddir)';
     }
+
+    my $s = $ENV{PKG_CONFIG_SYSROOT_DIR};
+    if (defined $s) {
+	    $variables->{pc_sysrootdir} = $s;
+    }
+    # The default '/' is implied.
 }
 
 $D = 1 if defined($ENV{PKG_CONFIG_DEBUG_SPEW});
@@ -392,7 +398,7 @@ sub do_cflags
 		my $l = $configs{$pkg}->get_property('Cflags', $variables);
 		push(@$cflags, @$l) if defined $l;
 	}
-	return OpenBSD::PkgConfig->compress($cflags,
+	my $a = OpenBSD::PkgConfig->compress($cflags,
 		sub {
 			local $_ = shift;
 			if (($mode{cflags} & 1) && /^-I/ ||
@@ -402,7 +408,13 @@ sub do_cflags
 			    return 0;
 			}
 		});
-	return undef;
+
+	if (defined($a) && defined($variables->{pc_sysrootdir})){
+		$a =~ s/^-I/$&$variables->{pc_sysrootdir}/g;
+		return $a;
+	} else {
+		return undef;
+	}
 }
 
 #if the lib option is set, pull out the linker flags
@@ -426,6 +438,11 @@ sub do_libs
 			    return 0;
 			}
 		});
+
+	if (defined($variables->{pc_sysrootdir})){
+		$a =~ s/^-[lL]/$&$variables->{pc_sysrootdir}/g;
+	}
+
 	if ($mode{libs} & 1) {
 		my $b = OpenBSD::PkgConfig->rcompress($libs,
 			sub { shift =~ m/^-l/; });
diff --git a/pkg-config.1 b/pkg-config.1
index c69f2fc..d670c41 100644
--- a/pkg-config.1
+++ b/pkg-config.1
@@ -148,6 +148,12 @@ will write the passed arguments.
 This can be used to specify a colon-separated list of paths to search for
 package files.
 If given, this list of paths is prepended to the standard search path.
+.It Ev PKG_CONFIG_SYSROOT_DIR
+This modifies -I and -L to use the target sysroot directory.
+Thus -I/usr/local/include will become -I/target/usr/local/include when
+PKG_CONFIG_SYSROOT_DIR is set to /target, which is useful when crosscompiling
+packages that use
+.Nm .
 .It Ev PKG_CONFIG_TOP_BUILD_DIR
 If set
 .Nm
-- 
1.7.3.5

